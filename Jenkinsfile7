pipeline {
    agent any
    
    stages {
        stage('Check Environment') {
            steps {
                sh '''
                    echo "=== Environment Check ==="
                    echo "Container: $(hostname)"
                    echo "User: $(whoami)"
                    echo "Python available: $(command -v python3 || echo 'No')"
                '''
            }
        }
        
        stage('Create Web Content') {
            steps {
                sh '''
                    echo "Creating web content..."
                    
                    # Create simple HTML file
                    mkdir -p $WORKSPACE/web
                    
                    cat > $WORKSPACE/web/index.html << 'HTML'
                    <html>
                    <head><title>Jenkins Test</title></head>
                    <body>
                        <h1>✅ Jenkins Web Server Test</h1>
                        <h2>Success!</h2>
                        <p>Running without sudo or Apache</p>
                        <p>Build: ${BUILD_NUMBER}</p>
                        <p>Time: $(date)</p>
                    </body>
                    </html>
                    HTML
                    
                    echo "Created: $WORKSPACE/web/index.html"
                '''
            }
        }
        
        stage('Start Web Server') {
            steps {
                script {
                    // Try different ports until we find one available
                    def port = sh(
                        script: '''
                            for p in 8000 8001 8002 9000 9001 9999; do
                                if ! timeout 1 bash -c "echo > /dev/tcp/127.0.0.1/\$p" 2>/dev/null; then
                                    echo \$p
                                    break
                                fi
                            done
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    if (!port) {
                        port = "8000"
                    }
                    
                    env.WEB_PORT = port
                }
                
                sh '''
                    echo "Starting web server on port ${WEB_PORT}..."
                    
                    # Start Python server
                    cd $WORKSPACE/web
                    python3 -m http.server ${WEB_PORT} &
                    
                    # Save PID
                    echo $! > $WORKSPACE/server.pid
                    
                    # Wait for server to start
                    sleep 3
                    
                    echo "Server started on http://localhost:${WEB_PORT}"
                '''
            }
        }
        
        stage('Test Connection') {
            steps {
                sh '''
                    echo "Testing web server..."
                    
                    # Test if server is responding
                    if curl -s http://localhost:${WEB_PORT} > /dev/null; then
                        echo "✅ SUCCESS: Web server is working!"
                        echo "Page title:"
                        curl -s http://localhost:${WEB_PORT} | grep -o "<title>.*</title>"
                    else
                        echo "❌ FAILED: Cannot connect to web server"
                        echo "Checking server process..."
                        ps aux | grep "http.server" | grep -v grep || echo "No server process found"
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            sh '''
                echo "Cleaning up..."
                if [ -f $WORKSPACE/server.pid ]; then
                    kill $(cat $WORKSPACE/server.pid) 2>/dev/null || true
                    rm -f $WORKSPACE/server.pid
                fi
                pkill -f "http.server" 2>/dev/null || true
            '''
            echo "Test completed"
        }
    }
}
