pipeline {
    agent any
    
    stages {
        stage('Check Container Environment') {
            steps {
                sh '''
                    echo "=== Container Environment ==="
                    echo "Running in container: $(hostname)"
                    echo "User: $(whoami) (UID: $(id -u))"
                    echo "Home: $HOME"
                    echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME || uname -a)"
                    echo "============================="
                '''
            }
        }
        
        stage('Try to Install Apache') {
            steps {
                sh '''
                    echo "Attempting to install Apache HTTP server..."
                    
                    # Check if we're in a Debian/Ubuntu container
                    if [ -f /etc/debian_version ]; then
                        echo "Debian/Ubuntu based container detected"
                        
                        # Update package lists
                        apt-get update 2>/dev/null || echo "Cannot update packages - need root"
                        
                        # Try to install Apache (may fail without root)
                        echo "Trying to install Apache..."
                        if apt-get install -y apache2 2>/dev/null; then
                            echo "Apache installed successfully!"
                        else
                            echo "Cannot install Apache - need root privileges"
                            echo "Will try alternative methods..."
                        fi
                    else
                        echo "Non-Debian container detected"
                    fi
                '''
            }
        }
        
        stage('Create Test Web Page') {
            steps {
                sh '''
                    echo "Creating test web page..."
                    
                    # Create web directory in workspace
                    mkdir -p $WORKSPACE/www
                    
                    # Create HTML file
                    cat > $WORKSPACE/www/index.html << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Jenkins Container Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="success">âœ… Jenkins Container Web Test</h1>
        <h2>Container Information</h2>
        <ul>
            <li><strong>Container ID:</strong> $(hostname)</li>
            <li><strong>User:</strong> $(whoami)</li>
            <li><strong>UID/GID:</strong> $(id -u)/$(id -g)</li>
        </ul>
        
        <h2>Build Information</h2>
        <ul>
            <li><strong>Job:</strong> ${JOB_NAME}</li>
            <li><strong>Build Number:</strong> ${BUILD_NUMBER}</li>
            <li><strong>Build Time:</strong> $(date)</li>
        </ul>
        
        <div class="info">
            <h3>Note:</h3>
            <p>Running in Docker container without sudo privileges.</p>
        </div>
    </div>
</body>
</html>
EOF
                    
                    echo "Test page created at: $WORKSPACE/www/index.html"
                '''
            }
        }
        
        stage('Test Web Server') {
            steps {
                sh '''
                    echo "Testing web server..."
                    
                    # Method 1: Check if Apache is running
                    echo "=== Checking for Apache ==="
                    if which apache2 > /dev/null 2>&1; then
                        echo "Apache is installed at: $(which apache2)"
                        echo "Checking if running on port 80..."
                        
                        # Check port 80
                        if timeout 2 bash -c "echo > /dev/tcp/localhost/80" 2>/dev/null; then
                            echo "Port 80 is open"
                            curl -s http://localhost | head -5
                        else
                            echo "Port 80 is not open"
                        fi
                    else
                        echo "Apache is not installed"
                    fi
                    
                    # Method 2: Start Python web server
                    echo ""
                    echo "=== Starting Python Web Server ==="
                    
                    if command -v python3 > /dev/null; then
                        echo "Python3 is available"
                        
                        # Start Python server
                        cd $WORKSPACE/www
                        python3 -m http.server 8080 > /tmp/python-server.log 2>&1 &
                        SERVER_PID=$!
                        
                        sleep 2
                        
                        # Test the server
                        if curl -s http://localhost:8080 > /dev/null; then
                            echo "Python web server is working on port 8080"
                            echo "Test URL: http://localhost:8080"
                            echo "Response preview:"
                            curl -s http://localhost:8080 | grep -o "<title>.*</title>"
                        else
                            echo "Python server is not responding"
                        fi
                        
                        # Kill the server
                        kill $SERVER_PID 2>/dev/null || true
                    else
                        echo "Python3 is not available"
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo "Build completed"
            sh '''
                echo "Cleaning up..."
                # Kill any remaining Python servers
                pkill -f "http.server" 2>/dev/null || true
            '''
        }
    }
}
