pipeline {
    agent{
        node {
            label 'dev'
        }
    }
    
    stages {
        stage('Install HTTPD') {
            steps {
                sh '''
                    echo "Installing Apache HTTPD..."
                    yum install -y httpd || apt-get install -y apache2
                '''
            }
        }
        
        stage('Start HTTPD Service') {
            steps {
                sh '''
                    echo "Starting HTTPD service..."
                    service start httpd || service start apache2
                    service enable httpd || service enable apache2
                '''
            }
        }
        
        stage('Create Test Page') {
            steps {
                sh '''
                    echo "Creating test page..."
                    echo "<html><body><h1>Hello from Jenkins!</h1><p>Server is running fine.</p></body></html>" > /var/www/html/index.html
                '''
            }
        }
        
        stage('Test Web Server') {
            steps {
                sh '''
                    echo "Testing web server..."
                    
                    # Install curl if not present
                    if ! command -v curl &> /dev/null; then
                        yum install -y curl || apt-get install -y curl
                    fi
                    
                    # Test if server is responding
                    if curl -s http://localhost | grep -q "Hello from Jenkins"; then
                        echo "✅ Web server is running correctly!"
                    else
                        echo "❌ Web server test failed!"
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo 'HTTPD deployment completed.'
        }
    }
}
