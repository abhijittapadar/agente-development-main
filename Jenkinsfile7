pipeline {
    agent{
        node {
            label 'dev'
        }
    }
    
    stages {
        stage('Check Container Environment') {
            steps {
                sh '''
                    echo "=== Container Environment ==="
                    echo "Running in container: $(hostname)"
                    echo "User: $(whoami) (UID: $(id -u))"
                    echo "Home: $HOME"
                    echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME || uname -a)"
                    echo "============================="
                '''
            }
        }
        
        stage('Install Apache as Root User') {
            steps {
                sh '''
                    echo "Installing Apache HTTP server..."
                    
                    # Since we're in a container, we need to run as root
                    # But Jenkins runs as 'jenkins' user
                    # We'll use apt-get directly without sudo
                    
                    # First check if we're in a Debian/Ubuntu container
                    if [ -f /etc/debian_version ]; then
                        echo "Debian/Ubuntu based container detected"
                        
                        # Update package lists
                        apt-get update || echo "Cannot update packages"
                        
                        # Try to install Apache
                        echo "Attempting to install Apache..."
                        if apt-get install -y apache2 2>/dev/null; then
                            echo "✅ Apache installed successfully!"
                        else
                            echo "❌ Cannot install Apache - need root privileges"
                            echo "Container needs to be built with Apache pre-installed"
                            exit 0  # Exit gracefully instead of failing
                        fi
                    else
                        echo "Non-Debian container. Cannot install Apache via apt."
                        exit 0
                    fi
                '''
            }
        }
        
        stage('Start Apache Service') {
            steps {
                sh '''
                    echo "Starting Apache..."
                    
                    # Try to start Apache
                    if which apache2 > /dev/null; then
                        echo "Apache found at: $(which apache2)"
                        
                        # Start Apache in foreground (containers need foreground processes)
                        echo "Starting Apache in foreground mode..."
                        apache2 -k start || \
                        /usr/sbin/apache2 -k start || \
                        echo "Could not start Apache service"
                        
                        # Check if Apache processes are running
                        sleep 2
                        if ps aux | grep -q '[a]pache2'; then
                            echo "✅ Apache processes are running"
                            ps aux | grep apache2 | grep -v grep
                        else
                            echo "⚠ Apache processes not found - trying alternative"
                        fi
                    else
                        echo "Apache not available"
                    fi
                '''
            }
        }
        
        stage('Create Test Web Page') {
            steps {
                sh '''
                    echo "Creating test web page..."
                    
                    # Create web directory if it doesn't exist
                    mkdir -p /var/www/html 2>/dev/null || mkdir -p $WORKSPACE/www
                    
                    # Create HTML file in workspace (always writable)
                    cat > $WORKSPACE/www/index.html << 'EOF'
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Jenkins Container Test</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                            .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                            .success { color: #28a745; }
                            .info { color: #17a2b8; }
                            .warning { color: #ffc107; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1 class="success">✅ Jenkins Container Web Test</h1>
                            <h2>Container Information</h2>
                            <ul>
                                <li><strong>Container ID:</strong> $(hostname)</li>
                                <li><strong>User:</strong> $(whoami)</li>
                                <li><strong>UID/GID:</strong> $(id -u)/$(id -g)</li>
                                <li><strong>Working Directory:</strong> $WORKSPACE</li>
                            </ul>
                            
                            <h2>Build Information</h2>
                            <ul>
                                <li><strong>Job:</strong> ${JOB_NAME}</li>
                                <li><strong>Build Number:</strong> ${BUILD_NUMBER}</li>
                                <li><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></li>
                                <li><strong>Build Time:</strong> $(date)</li>
                            </ul>
                            
                            <div class="info">
                                <h3>⚠ Note:</h3>
                                <p>Running in Docker container without sudo privileges.</p>
                                <p>Apache needs to be pre-installed in the container image.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                    EOF
                    
                    echo "Test page created at: $WORKSPACE/www/index.html"
                    
                    # Try to copy to Apache directory if accessible
                    if [ -d /var/www/html ] && [ -w /var/www/html ]; then
                        cp $WORKSPACE/www/index.html /var/www/html/
                        echo "Copied to /var/www/html/"
                    else
                        echo "Cannot write to /var/www/html - using workspace only"
                    fi
                '''
            }
        }
        
        stage('Test Web Server') {
            steps {
                sh '''
                    echo "Testing web server..."
                    
                    # Method 1: Check if Apache is running on port 80
                    echo "=== Method 1: Port 80 Check ==="
                    if timeout 2 bash -c 'echo > /dev/tcp/localhost/80' 2>/dev/null; then
                        echo "✅ Port 80 is listening"
                        echo "Testing HTTP response..."
                        curl -s -I http://localhost | head -5
                        echo "Page content preview:"
                        curl -s http://localhost | grep -o "<title>.*</title>" || curl -s http://localhost | head -3
                    else
                        echo "❌ Port 80 is not open"
                    fi
                    
                    # Method 2: Start Python web server as fallback
                    echo ""
                    echo "=== Method 2: Python Web Server (Fallback) ==="
                    
                    if command -v python3 > /dev/null; then
                        echo "Python3 available - starting test server..."
                        
                        # Start Python server in background
                        cd $WORKSPACE/www
                        python3 -m http.server 8080 > /tmp/python-server.log 2>&1 &
                        PYTHON_PID=$!
                        
                        sleep 2
                        
                        # Test the Python server
                        if curl -s http://localhost:8080 > /dev/null; then
                            echo "✅ Python web server working on port 8080"
                            echo "Server URL: http://localhost:8080"
                            echo "Response:"
                            curl -s http://localhost:8080 | grep -o "<h1>.*</h1>" || true
                        else
                            echo "❌ Python server not responding"
                            echo "Logs:"
                            tail -5 /tmp/python-server.log 2>/dev/null || echo "No logs"
                        fi
                        
                        # Kill the Python server
                        kill $PYTHON_PID 2>/dev/null || true
                    else
                        echo "Python3 not available for fallback server"
                    fi
                    
                    # Method 3: Just serve static file without server
                    echo ""
                    echo "=== Method 3: Static File Check ==="
                    echo "HTML file created at: $WORKSPACE/www/index.html"
                    echo "File size: $(wc -c < $WORKSPACE/www/index.html) bytes"
                    echo "First 3 lines:"
                    head -3 $WORKSPACE/www/index.html
                '''
            }
        }
    }
    
    post {
        always {
            echo "=== Build Summary ==="
            echo "Container: $(hostname)"
            echo "Build: ${BUILD_NUMBER}"
            echo "Status: ${currentBuild.currentResult}"
            echo "====================="
            
            sh '''
                echo "Cleaning up..."
                # Kill any Python servers that might still be running
                pkill -f "http.server" 2>/dev/null || true
            '''
        }
    }
}

